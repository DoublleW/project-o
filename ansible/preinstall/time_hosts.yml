---
- name: time_hosts
  hosts: preinstall_hosts
  become: yes

  tasks:

    - name: update & upgrade system
      shell: sudo apt update && apt upgrade -y

    - name: install snap
      shell: sudo apt install snapd -y

    - name: Timezone
      shell: |
        sudo timedatectl set-timezone {{ time_zone }}

    - name: Install ntpdate
      apt:
        name: ntp
        state: latest

    - name: Add ntp servers
      shell: |
        sudo mv /etc/ntp.conf /etc/ntp.conf.$(date +%F_%R)
        sudo echo 'server 0.ru.pool.ntp.org prefer iburst' > /etc/ntp.conf
        sudo echo 'server 1.ru.pool.ntp.org prefer iburst' >> /etc/ntp.conf
        sudo service ntp restart

    - name: Make sure ntp is started, and is enabled on restart.
      service: 
        name: ntp 
        state: started 
        enabled: yes


## change quantity loop if there are fewer or more hosts
    - name: copy old hosts config
      shell: sudo mv -f /etc/hosts /etc/hosts.bk
    - name: create /etc/hosts
      shell: sudo touch /etc/hosts

    - name: Add mappings to /etc/hosts
      blockinfile:
        path: /etc/hosts
        block: |
          {{ item.ip }}    {{ item.name }}
        marker: "# kubernetes & nginx"
      loop:
        - { name: "{{ server_main }}", ip: "{{ server_main_ip }}" }
        - { name: "{{ server_1 }}", ip: "{{ server_1_ip }}" }
        - { name: "{{ server_2 }}", ip: "{{ server_2_ip }}" }
        - { name: "{{ server_3 }}", ip: "{{ server_3_ip }}" }
        - { name: "{{ server_4 }}", ip: "{{ server_4_ip }}" }
        - { name: "{{ server_5 }}", ip: "{{ server_5_ip }}" }

